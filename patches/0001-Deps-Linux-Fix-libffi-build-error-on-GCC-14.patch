From 3165341c655dab339f5681d47c71e78e99a0989d Mon Sep 17 00:00:00 2001
From: lfdevs <109842948+lfdevs@users.noreply.github.com>
Date: Thu, 29 Jan 2026 16:15:43 +0800
Subject: [PATCH] Deps: Linux: Fix libffi build error on GCC 14

The patch is from: https://github.com/libffi/libffi/pull/764
---
 build_files/build_environment/cmake/ffi.cmake |  4 +++
 .../patches/ffi_gcc14_fix.diff                | 30 +++++++++++++++++++
 2 files changed, 34 insertions(+)
 create mode 100644 build_files/build_environment/patches/ffi_gcc14_fix.diff

diff --git a/build_files/build_environment/cmake/ffi.cmake b/build_files/build_environment/cmake/ffi.cmake
index 9ca50c4a..945533d4 100644
--- a/build_files/build_environment/cmake/ffi.cmake
+++ b/build_files/build_environment/cmake/ffi.cmake
@@ -29,6 +29,10 @@ ExternalProject_Add(external_ffi
     # Fix compilation errors on Apple Clang >= 17, remove when FFI is updated beyond 3.4.7, see PR #136934 for details.
     ${BUILD_DIR}/ffi/src/external_ffi <
     ${PATCH_DIR}/ffi_apple_clang_17.diff
+  COMMAND ${PATCH_CMD} -p 1 -d
+    # Fix compilation errors on GCC >= 14, remove when FFI is updated beyond 3.4.6. The patch is from https://github.com/libffi/libffi/pull/764
+    ${BUILD_DIR}/ffi/src/external_ffi <
+    ${PATCH_DIR}/ffi_gcc14_fix.diff
 
   INSTALL_DIR ${LIBDIR}/ffi
 )
diff --git a/build_files/build_environment/patches/ffi_gcc14_fix.diff b/build_files/build_environment/patches/ffi_gcc14_fix.diff
new file mode 100644
index 00000000..d5c83b79
--- /dev/null
+++ b/build_files/build_environment/patches/ffi_gcc14_fix.diff
@@ -0,0 +1,30 @@
+diff --git a/include/ffi_common.h b/include/ffi_common.h
+index 2bd31b03d..c53a79493 100644
+--- a/include/ffi_common.h
++++ b/include/ffi_common.h
+@@ -128,6 +128,10 @@ void *ffi_data_to_code_pointer (void *data) FFI_HIDDEN;
+    static trampoline. */
+ int ffi_tramp_is_present (void *closure) FFI_HIDDEN;
+ 
++/* Return a file descriptor of a temporary zero-sized file in a
++   writable and executable filesystem. */
++int open_temp_exec_file(void) FFI_HIDDEN;
++
+ /* Extended cif, used in callback from assembly routine */
+ typedef struct
+ {
+diff --git a/src/tramp.c b/src/tramp.c
+index b9d273a1a..c3f4c9933 100644
+--- a/src/tramp.c
++++ b/src/tramp.c
+@@ -39,6 +39,10 @@
+ #ifdef __linux__
+ #define _GNU_SOURCE 1
+ #endif
++
++#include <ffi.h>
++#include <ffi_common.h>
++
+ #include <stdio.h>
+ #include <unistd.h>
+ #include <stdlib.h>
-- 
2.43.7

